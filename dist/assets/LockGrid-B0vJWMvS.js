import{z as V,A as v,B as u,c as m,v as _,f as a,n as b,e as U,M as j,N as I,P as q,t as x,o as G,F as K,j as M,y as R}from"./vendor-B4Lc8i9O.js";import{u as z,f as Z}from"./utils-C-osJSqK.js";import{b as L,_ as J}from"./index-DR1ax7Lz.js";const H=V("locks",()=>{const c=z(),s=v([]),d=v([]),p=v(!1),k=v(null);v(null);const n=v(null),f=v({}),N=u(()=>s.value.filter(t=>t.is_online)),$=u(()=>s.value.filter(t=>!t.is_online)),y=u(()=>s.value.filter(t=>t.status?.is_locked).length),F=u(()=>s.value.filter(t=>!t.status?.is_locked).length),T=async()=>{if(!p.value){p.value=!0,k.value=null;try{const t=await L.get("/locks"),e=[...s.value];s.value=t.data.data.map(o=>({...o,config:JSON.parse(o.config_data||"{}"),status:JSON.parse(o.status_data||"{}")})),e.forEach(o=>{const l=s.value.find(r=>r.id===o.id);if(l&&f.value[o.id]){const r=o.status?.is_locked,E=l.status?.is_locked;r!==E&&(f.value[o.id]=!1)}})}catch(t){k.value=t.response?.data?.message||"Failed to fetch locks",console.error("Fetch locks error:",t)}finally{p.value=!1}}},S=async t=>{try{const e=await L.get(`/locks/${t}`),o={...e.data.data,config:JSON.parse(e.data.data.config_data||"{}"),status:JSON.parse(e.data.data.status_data||"{}")},l=s.value.findIndex(r=>r.id===t);return l!==-1&&(s.value[l]={...o}),o}catch(e){return console.error("Fetch single lock error:",e),null}},w=async()=>{try{const t=await L.get("/locks/status");d.value=t.data.data||[],s.value.forEach(e=>{const o=d.value.find(l=>l.lock_id===e.id);o&&(e.status=o.status,e.is_online=o.status==="online",e.last_updated=o.last_updated)})}catch(t){console.error("Fetch lock status error:",t)}},O=async t=>{const e=s.value.find(o=>o.id===t);if(e){if(!e.is_online){c.error("Cannot control offline lock");return}if(!f.value[t]){f.value[t]=!0;try{const o=e.status?.is_locked?"unlock":"lock",l=o==="lock",r=new Date().toISOString();if((await L.post(`/locks/${t}/control`,{action:o})).data.status==="success"){c.success(`${e.name} command sent`),e.last_command_time=r;const B=async()=>{(await S(t))?.status?.is_locked===l?f.value[t]=!1:setTimeout(B,1e3)};B()}}catch(o){k.value=o.response?.data?.message||"Failed to control lock",c.error(`Failed to control lock: ${o.response?.data?.message||o.message}`),f.value[t]=!1}}}},P=async(t,e)=>{try{if((await L.put(`/locks/${t}`,{name:e})).data.status==="success"){const l=s.value.find(r=>r.id===t);l&&(l.name=e),c.success("Lock name updated")}}catch(o){c.error("Failed to update lock name"),console.error("Update lock name error:",o)}},h=async(t,e)=>{try{if((await L.post(`/locks/${t}/control`,{action:e})).data.status==="success"){const l=s.value.find(r=>r.id===t)?.name||"Lock";return c.success(`${l} ${e} command sent`),!0}}catch(o){return console.error("Lock control error:",o),c.error(`Failed to ${e} lock`),!1}},D=async()=>{const t=s.value.filter(e=>!e.status?.is_locked&&e.is_online).map(e=>h(e.id,"lock"));await Promise.all(t)},A=async()=>{const t=s.value.filter(e=>e.status?.is_locked&&e.is_online).map(e=>h(e.id,"unlock"));await Promise.all(t)},g=()=>s.value.filter(t=>!t.is_online),i=(t,e)=>{const o=s.value.find(l=>l.id===t);o&&Object.assign(o.status,e)},C=()=>{if(n.value)return;const t=parseInt("60000")||3e4;n.value=setInterval(async()=>{await w()},t)};return{locks:s,lockStatus:d,loading:p,error:k,lockLoadingStates:f,onlineLocks:N,offlineLocks:$,lockedCount:y,unlockedCount:F,fetchLocks:T,fetchSingleLock:S,fetchLockStatus:w,toggleLock:O,updateLockName:P,controlLock:h,lockAll:D,unlockAll:A,getOfflineLocks:g,updateLockStatus:i,startPolling:C,stopPolling:()=>{n.value&&(clearInterval(n.value),n.value=null)},startRealTimeUpdates:()=>{C()}}}),Q={class:"card-content"},W={class:"lock-header"},X={class:"lock-icon-container"},Y={class:"lock-info"},ss={class:"lock-name-container"},ts={key:0,class:"edit-container"},es=["disabled"],os={key:1,class:"lock-name"},as={class:"lock-location"},cs={class:"lock-action"},ls=["disabled"],ns={key:0,class:"loading-spinner"},is={class:"lock-footer"},rs={class:"last-activity"},us={__name:"LockCard",props:{lock:{type:Object,required:!0}},setup(c){const s=c,d=H(),p=z(),k=v(!1),n=v(""),f=v(null),N=u(()=>n.value.trim()!==s.lock.name&&n.value.trim()!==""),$=u(()=>{const g=s.lock.last_command_time||s.lock.status?.last_activity||s.lock.updated_at;return console.log("Computing last activity for lock",s.lock.id,":",g),y.value?"...":A(g)}),y=u(()=>d.lockLoadingStates[s.lock.id]||!1),F=u(()=>({"lock-card--locked":s.lock.status?.is_locked&&s.lock.is_online,"lock-card--unlocked":!s.lock.status?.is_locked&&s.lock.is_online,"lock-card--offline":!s.lock.is_online})),T=u(()=>({"lock-icon--locked":s.lock.status?.is_locked&&s.lock.is_online,"lock-icon--unlocked":!s.lock.status?.is_locked&&s.lock.is_online,"lock-icon--offline":!s.lock.is_online})),S=u(()=>({"status-indicator--online":s.lock.is_online,"status-indicator--offline":!s.lock.is_online})),w=u(()=>({"action-button--lock":!s.lock.status?.is_locked&&s.lock.is_online,"action-button--unlock":s.lock.status?.is_locked&&s.lock.is_online,"action-button--disabled":!s.lock.is_online})),O=async()=>{await d.toggleLock(s.lock.id)},P=async()=>{n.value=s.lock.name,k.value=!0,await G(),f.value?.focus()},h=async()=>{if(!n.value.trim()){p.error("Lock name cannot be empty");return}n.value.trim()!==s.lock.name&&await d.updateLockName(s.lock.id,n.value.trim()),k.value=!1},D=()=>{k.value=!1,n.value=""},A=g=>{console.log("Formatting date:",g,"for lock:",s.lock.id);const i=new Date(g+"Z");return Z(i,{addSuffix:!0})};return(g,i)=>(_(),m("div",{class:b(["card lock-card",F.value])},[a("div",Q,[a("div",W,[a("div",X,[a("i",{class:b(["fas fa-lock lock-icon",T.value])},null,2),a("div",{class:b(["status-indicator",S.value])},null,2)]),a("div",Y,[a("div",ss,[k.value?(_(),m("div",ts,[j(a("input",{"onUpdate:modelValue":i[0]||(i[0]=C=>n.value=C),onKeyup:q(h,["enter"]),class:"lock-name-input",ref_key:"nameInput",ref:f},null,544),[[I,n.value]]),a("button",{onClick:h,class:"save-btn",disabled:!N.value},[...i[1]||(i[1]=[a("i",{class:"fas fa-check"},null,-1)])],8,es),a("button",{onClick:D,class:"cancel-btn"},[...i[2]||(i[2]=[a("i",{class:"fas fa-times"},null,-1)])])])):(_(),m("h3",os,x(c.lock.name),1)),k.value?U("",!0):(_(),m("button",{key:2,onClick:P,class:"edit-name-btn"},[...i[3]||(i[3]=[a("i",{class:"fas fa-edit"},null,-1)])]))]),a("p",as,x(c.lock.location),1)])]),a("div",cs,[a("button",{class:b(["action-button",w.value]),onClick:O,disabled:y.value||!c.lock.is_online},[y.value?(_(),m("div",ns)):(_(),m("i",{key:1,class:b(c.lock.status?.is_locked?"fas fa-unlock":"fas fa-lock")},null,2)),a("span",null,x(y.value?"Processing...":c.lock.status?.is_locked?"Unlock":"Lock"),1)],10,ls)]),a("div",is,[a("span",rs,x($.value),1)])])],2))}},ds=J(us,[["__scopeId","data-v-930e91ca"]]),ks={class:"lock-grid"},fs={class:"columns is-multiline"},vs={key:0,class:"has-text-centered py-6"},ms={__name:"LockGrid",props:{locks:{type:Array,required:!0}},setup(c){return(s,d)=>(_(),m("div",ks,[a("div",fs,[(_(!0),m(K,null,M(c.locks,p=>(_(),m("div",{key:p.id,class:"column is-12-mobile is-6-tablet is-4-desktop is-3-widescreen"},[R(ds,{lock:p},null,8,["lock"])]))),128))]),c.locks.length===0?(_(),m("div",vs,[...d[0]||(d[0]=[a("i",{class:"fas fa-lock is-size-1 has-text-white-ter mb-4"},null,-1),a("p",{class:"has-text-white-ter is-size-5"},"No locks found",-1),a("p",{class:"has-text-white-ter"},"Add your first smart lock to get started",-1)])])):U("",!0)]))}},bs=J(ms,[["__scopeId","data-v-e482f460"]]);export{bs as L,H as u};
