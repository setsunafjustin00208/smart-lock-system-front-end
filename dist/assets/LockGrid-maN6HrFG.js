import{z as j,A as f,B as d,c as v,v as m,f as a,n as S,e as z,M as I,N as q,Q as G,t as N,u as K,o as M,F as R,j as Q,y as Z}from"./vendor-DfHZLmVz.js";import{u as J,f as H}from"./utils-BVVFTmOF.js";import{b as y,_ as V,u as W}from"./index-BOl8aQ0f.js";const X=j("locks",()=>{const c=J(),s=f([]),k=f([]),_=f(!1),g=f(null);f(null);const r=f(null),l=f({}),b=d(()=>s.value.filter(t=>t.is_online)),$=d(()=>s.value.filter(t=>!t.is_online)),F=d(()=>s.value.filter(t=>t.status?.is_locked).length),h=d(()=>s.value.filter(t=>!t.status?.is_locked).length),T=async()=>{if(!_.value){_.value=!0,g.value=null;try{const t=await y.get("/locks"),e=[...s.value];s.value=t.data.data.map(o=>({...o,config:JSON.parse(o.config_data||"{}"),status:JSON.parse(o.status_data||"{}")})),e.forEach(o=>{const n=s.value.find(u=>u.id===o.id);if(n&&l.value[o.id]){const u=o.status?.is_locked,B=n.status?.is_locked;u!==B&&(l.value[o.id]=!1)}})}catch(t){g.value=t.response?.data?.message||"Failed to fetch locks",console.error("Fetch locks error:",t)}finally{_.value=!1}}},w=async t=>{try{const e=await y.get(`/locks/${t}`),o={...e.data.data,config:JSON.parse(e.data.data.config_data||"{}"),status:JSON.parse(e.data.data.status_data||"{}")},n=s.value.findIndex(u=>u.id===t);return n!==-1&&(s.value[n]={...o}),o}catch(e){return console.error("Fetch single lock error:",e),null}},C=async()=>{try{const t=await y.get("/locks/status");k.value=t.data.data||[],s.value.forEach(e=>{const o=k.value.find(n=>n.lock_id===e.id);o&&(e.status=o.status,e.is_online=o.status==="online",e.last_updated=o.last_updated)})}catch(t){console.error("Fetch lock status error:",t)}},A=async t=>{const e=s.value.find(o=>o.id===t);if(e){if(!e.is_online){c.error("Cannot control offline lock");return}if(!l.value[t]){l.value[t]=!0;try{const o=e.status?.is_locked?"unlock":"lock",n=o==="lock",u=new Date().toISOString();if((await y.post(`/locks/${t}/control`,{action:o})).data.status==="success"){c.success(`${e.name} command sent`),e.last_command_time=u;const U=async()=>{(await w(t))?.status?.is_locked===n?l.value[t]=!1:setTimeout(U,1e3)};U()}}catch(o){g.value=o.response?.data?.message||"Failed to control lock",c.error(`Failed to control lock: ${o.response?.data?.message||o.message}`),l.value[t]=!1}}}},O=async(t,e)=>{try{if((await y.put(`/locks/${t}`,{name:e})).data.status==="success"){const n=s.value.find(u=>u.id===t);n&&(n.name=e),c.success("Lock name updated")}}catch(o){c.error("Failed to update lock name"),console.error("Update lock name error:",o)}},L=async(t,e)=>{try{if((await y.post(`/locks/${t}/control`,{action:e})).data.status==="success"){const n=s.value.find(u=>u.id===t)?.name||"Lock";return c.success(`${n} ${e} command sent`),!0}}catch(o){return console.error("Lock control error:",o),c.error(`Failed to ${e} lock`),!1}},x=async()=>{const t=s.value.filter(e=>!e.status?.is_locked&&e.is_online).map(e=>L(e.id,"lock"));await Promise.all(t)},D=async()=>{const t=s.value.filter(e=>e.status?.is_locked&&e.is_online).map(e=>L(e.id,"unlock"));await Promise.all(t)},P=()=>s.value.filter(t=>!t.is_online),p=(t,e)=>{const o=s.value.find(n=>n.id===t);o&&Object.assign(o.status,e)},i=()=>{if(r.value)return;const t=parseInt("60000")||3e4;r.value=setInterval(async()=>{await C()},t)};return{locks:s,lockStatus:k,loading:_,error:g,lockLoadingStates:l,onlineLocks:b,offlineLocks:$,lockedCount:F,unlockedCount:h,fetchLocks:T,fetchSingleLock:w,fetchLockStatus:C,toggleLock:A,updateLockName:O,controlLock:L,lockAll:x,unlockAll:D,getOfflineLocks:P,updateLockStatus:p,startPolling:i,stopPolling:()=>{r.value&&(clearInterval(r.value),r.value=null)},startRealTimeUpdates:()=>{i()}}}),Y={class:"card-content"},ss={class:"lock-header"},ts={class:"lock-icon-container"},es={class:"lock-info"},os={class:"lock-name-container"},as={key:0,class:"edit-container"},cs=["disabled"],ls={key:1,class:"lock-name"},ns={class:"lock-location"},is={class:"lock-action"},rs=["disabled"],us={key:0,class:"loading-spinner"},ds={class:"lock-footer"},ks={class:"last-activity"},fs={__name:"LockCard",props:{lock:{type:Object,required:!0}},setup(c){const s=c,k=X(),_=W(),g=J(),r=f(!1),l=f(""),b=f(null),$=d(()=>l.value.trim()!==s.lock.name&&l.value.trim()!==""),F=d(()=>{const p=s.lock.last_command_time||s.lock.status?.last_activity||s.lock.updated_at;return console.log("Computing last activity for lock",s.lock.id,":",p),h.value?"...":P(p)}),h=d(()=>k.lockLoadingStates[s.lock.id]||!1),T=d(()=>({"lock-card--locked":s.lock.status?.is_locked&&s.lock.is_online,"lock-card--unlocked":!s.lock.status?.is_locked&&s.lock.is_online,"lock-card--offline":!s.lock.is_online})),w=d(()=>({"lock-icon--locked":s.lock.status?.is_locked&&s.lock.is_online,"lock-icon--unlocked":!s.lock.status?.is_locked&&s.lock.is_online,"lock-icon--offline":!s.lock.is_online})),C=d(()=>({"status-indicator--online":s.lock.is_online,"status-indicator--offline":!s.lock.is_online})),A=d(()=>({"action-button--lock":!s.lock.status?.is_locked&&s.lock.is_online,"action-button--unlock":s.lock.status?.is_locked&&s.lock.is_online,"action-button--disabled":!s.lock.is_online})),O=async()=>{await k.toggleLock(s.lock.id)},L=async()=>{l.value=s.lock.name,r.value=!0,await M(),b.value?.focus()},x=async()=>{if(!l.value.trim()){g.error("Lock name cannot be empty");return}l.value.trim()!==s.lock.name&&await k.updateLockName(s.lock.id,l.value.trim()),r.value=!1},D=()=>{r.value=!1,l.value=""},P=p=>{console.log("Formatting date:",p,"for lock:",s.lock.id);const i=new Date(p+"Z");return H(i,{addSuffix:!0})};return(p,i)=>(m(),v("div",{class:S(["card lock-card",T.value])},[a("div",Y,[a("div",ss,[a("div",ts,[a("i",{class:S(["fas fa-lock lock-icon",w.value])},null,2),a("div",{class:S(["status-indicator",C.value])},null,2)]),a("div",es,[a("div",os,[r.value?(m(),v("div",as,[I(a("input",{"onUpdate:modelValue":i[0]||(i[0]=E=>l.value=E),onKeyup:G(x,["enter"]),class:"lock-name-input",ref_key:"nameInput",ref:b},null,544),[[q,l.value]]),a("button",{onClick:x,class:"save-btn",disabled:!$.value},[...i[1]||(i[1]=[a("i",{class:"fas fa-check"},null,-1)])],8,cs),a("button",{onClick:D,class:"cancel-btn"},[...i[2]||(i[2]=[a("i",{class:"fas fa-times"},null,-1)])])])):(m(),v("h3",ls,N(c.lock.name),1)),!r.value&&K(_).isAdmin?(m(),v("button",{key:2,onClick:L,class:"edit-name-btn"},[...i[3]||(i[3]=[a("i",{class:"fas fa-edit"},null,-1)])])):z("",!0)]),a("p",ns,N(c.lock.location),1)])]),a("div",is,[a("button",{class:S(["action-button",A.value]),onClick:O,disabled:h.value||!c.lock.is_online},[h.value?(m(),v("div",us)):(m(),v("i",{key:1,class:S(c.lock.status?.is_locked?"fas fa-unlock":"fas fa-lock")},null,2)),a("span",null,N(h.value?"Processing...":c.lock.status?.is_locked?"Unlock":"Lock"),1)],10,rs)]),a("div",ds,[a("span",ks,N(F.value),1)])])],2))}},vs=V(fs,[["__scopeId","data-v-998101ef"]]),ms={class:"lock-grid"},_s={class:"columns is-multiline"},ps={key:0,class:"has-text-centered py-6"},gs={__name:"LockGrid",props:{locks:{type:Array,required:!0}},setup(c){return(s,k)=>(m(),v("div",ms,[a("div",_s,[(m(!0),v(R,null,Q(c.locks,_=>(m(),v("div",{key:_.id,class:"column is-12-mobile is-6-tablet is-4-desktop is-3-widescreen"},[Z(vs,{lock:_},null,8,["lock"])]))),128))]),c.locks.length===0?(m(),v("div",ps,[...k[0]||(k[0]=[a("i",{class:"fas fa-lock is-size-1 has-text-white-ter mb-4"},null,-1),a("p",{class:"has-text-white-ter is-size-5"},"No locks found",-1),a("p",{class:"has-text-white-ter"},"Add your first smart lock to get started",-1)])])):z("",!0)]))}},ws=V(gs,[["__scopeId","data-v-e482f460"]]);export{ws as L,X as u};
