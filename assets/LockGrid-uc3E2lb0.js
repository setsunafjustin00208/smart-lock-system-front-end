import{z as D,A as f,B as u,c as _,v,f as c,n as p,t as L,e as E,F as J,j,y as q}from"./vendor-vMbJagej.js";import{u as R,f as U}from"./utils-BKUfGzfw.js";import{a as g,_ as F}from"./index-BQXzYUwg.js";const V=D("locks",()=>{const a=R(),t=f([]),r=f([]),n=f(!1),m=f(null);f(null);const d=f(null),i=f({}),S=u(()=>t.value.filter(s=>s.is_online)),w=u(()=>t.value.filter(s=>!s.is_online)),$=u(()=>t.value.filter(s=>s.status?.is_locked).length),h=u(()=>t.value.filter(s=>!s.status?.is_locked).length),C=async()=>{if(!n.value){n.value=!0,m.value=null;try{const s=await g.get("/locks"),e=[...t.value];t.value=s.data.data.map(o=>({...o,config:JSON.parse(o.config_data||"{}"),status:JSON.parse(o.status_data||"{}")})),e.forEach(o=>{const l=t.value.find(k=>k.id===o.id);if(l&&i.value[o.id]){const k=o.status?.is_locked,z=l.status?.is_locked;k!==z&&(i.value[o.id]=!1)}})}catch(s){m.value=s.response?.data?.message||"Failed to fetch locks",console.error("Fetch locks error:",s)}finally{n.value=!1}}},y=async s=>{try{const e=await g.get(`/locks/${s}`),o={...e.data.data,config:JSON.parse(e.data.data.config_data||"{}"),status:JSON.parse(e.data.data.status_data||"{}")},l=t.value.findIndex(k=>k.id===s);return l!==-1&&(t.value[l]=o,i.value[s]=!1),o}catch(e){return console.error("Fetch single lock error:",e),null}},x=async()=>{try{const s=await g.get("/locks/status");r.value=s.data.data||[],t.value.forEach(e=>{const o=r.value.find(l=>l.lock_id===e.id);o&&(e.status=o.status,e.is_online=o.status==="online",e.last_updated=o.last_updated)})}catch(s){console.error("Fetch lock status error:",s)}},T=async s=>{const e=t.value.find(o=>o.id===s);if(e){if(!e.is_online){a.error("Cannot control offline lock");return}i.value[s]=!0;try{const o=e.status?.is_locked?"unlock":"lock";console.log("Sending request:",{url:`/locks/${s}/control`,data:{action:o}});const l=await g.post(`/locks/${s}/control`,{action:o});console.log("Response:",l.data),l.data.status==="success"&&(a.success(`${e.name} command sent`),console.log(`${o} command sent for lock ${s}`),setTimeout(async()=>{await y(s)},2e3),setTimeout(async()=>{i.value[s]&&await y(s)},4e3),setTimeout(async()=>{i.value[s]&&(await y(s),i.value[s]=!1)},6e3))}catch(o){console.error("Toggle lock error:",o),console.error("Error response:",o.response?.data),m.value=o.response?.data?.message||"Failed to control lock",a.error(`Failed to control lock: ${o.response?.data?.message||o.message}`),i.value[s]=!1}}},b=async(s,e)=>{try{if((await g.post(`/locks/${s}/control`,{action:e})).data.status==="success"){const l=t.value.find(k=>k.id===s)?.name||"Lock";return a.success(`${l} ${e} command sent`),!0}}catch(o){return console.error("Lock control error:",o),a.error(`Failed to ${e} lock`),!1}},O=async()=>{const s=t.value.filter(e=>!e.status?.is_locked&&e.is_online).map(e=>b(e.id,"lock"));await Promise.all(s)},P=async()=>{const s=t.value.filter(e=>e.status?.is_locked&&e.is_online).map(e=>b(e.id,"unlock"));await Promise.all(s)},A=()=>t.value.filter(s=>!s.is_online),B=(s,e)=>{const o=t.value.find(l=>l.id===s);o&&Object.assign(o.status,e)},N=()=>{if(d.value)return;const s=parseInt("60000")||3e4;d.value=setInterval(async()=>{await x()},s)};return{locks:t,lockStatus:r,loading:n,error:m,lockLoadingStates:i,onlineLocks:S,offlineLocks:w,lockedCount:$,unlockedCount:h,fetchLocks:C,fetchSingleLock:y,fetchLockStatus:x,toggleLock:T,controlLock:b,lockAll:O,unlockAll:P,getOfflineLocks:A,updateLockStatus:B,startPolling:N,stopPolling:()=>{d.value&&(clearInterval(d.value),d.value=null)},startRealTimeUpdates:()=>{N()}}}),G={class:"card-content"},H={class:"lock-header"},K={class:"lock-icon-container"},M={class:"lock-info"},Q={class:"lock-name"},W={class:"lock-location"},X={class:"lock-action"},Y=["disabled"],Z={key:0,class:"loading-spinner"},I={class:"lock-footer"},ss={class:"last-activity"},ts={__name:"LockCard",props:{lock:{type:Object,required:!0}},setup(a){const t=a,r=V(),n=u(()=>r.lockLoadingStates[t.lock.id]||!1),m=u(()=>({"lock-card--locked":t.lock.status?.is_locked&&t.lock.is_online,"lock-card--unlocked":!t.lock.status?.is_locked&&t.lock.is_online,"lock-card--offline":!t.lock.is_online})),d=u(()=>({"lock-icon--locked":t.lock.status?.is_locked&&t.lock.is_online,"lock-icon--unlocked":!t.lock.status?.is_locked&&t.lock.is_online,"lock-icon--offline":!t.lock.is_online})),i=u(()=>({"status-indicator--online":t.lock.is_online,"status-indicator--offline":!t.lock.is_online})),S=u(()=>({"action-button--lock":!t.lock.status?.is_locked&&t.lock.is_online,"action-button--unlock":t.lock.status?.is_locked&&t.lock.is_online,"action-button--disabled":!t.lock.is_online})),w=async()=>{await r.toggleLock(t.lock.id)},$=h=>U(new Date(h),{addSuffix:!0});return(h,C)=>(v(),_("div",{class:p(["card lock-card",m.value])},[c("div",G,[c("div",H,[c("div",K,[c("i",{class:p(["fas fa-lock lock-icon",d.value])},null,2),c("div",{class:p(["status-indicator",i.value])},null,2)]),c("div",M,[c("h3",Q,L(a.lock.name),1),c("p",W,L(a.lock.location),1)])]),c("div",X,[c("button",{class:p(["action-button",S.value]),onClick:w,disabled:n.value||!a.lock.is_online},[n.value?(v(),_("div",Z)):(v(),_("i",{key:1,class:p(a.lock.status?.is_locked?"fas fa-unlock":"fas fa-lock")},null,2)),c("span",null,L(n.value?"Processing...":a.lock.status?.is_locked?"Unlock":"Lock"),1)],10,Y)]),c("div",I,[c("span",ss,L($(a.lock.status?.last_activity||a.lock.updated_at)),1)])])],2))}},os=F(ts,[["__scopeId","data-v-201b037a"]]),es={class:"lock-grid"},as={class:"columns is-multiline"},cs={key:0,class:"has-text-centered py-6"},ls={__name:"LockGrid",props:{locks:{type:Array,required:!0}},setup(a){return(t,r)=>(v(),_("div",es,[c("div",as,[(v(!0),_(J,null,j(a.locks,n=>(v(),_("div",{key:n.id,class:"column is-12-mobile is-6-tablet is-4-desktop is-3-widescreen"},[q(os,{lock:n},null,8,["lock"])]))),128))]),a.locks.length===0?(v(),_("div",cs,[...r[0]||(r[0]=[c("i",{class:"fas fa-lock is-size-1 has-text-white-ter mb-4"},null,-1),c("p",{class:"has-text-white-ter is-size-5"},"No locks found",-1),c("p",{class:"has-text-white-ter"},"Add your first smart lock to get started",-1)])])):E("",!0)]))}},ks=F(ls,[["__scopeId","data-v-e482f460"]]);export{ks as L,V as u};
